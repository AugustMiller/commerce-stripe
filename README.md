Stripe payment gateway for Craft Commerce
=======================

This plugin provides a [Stripe](https://stripe.com/) integration for [Craft Commerce](https://craftcommerce.com/).


## Requirements

This plugin requires Craft Commerce 2.0.1-alpha.4 or later.


## Installation

To install the plugin, follow these instructions.

1. Open your terminal and go to your Craft project:

        cd /path/to/project

2. Then tell Composer to load the plugin:

        composer require craftcms/commerce-stripe

3. In the Control Panel, go to Settings → Plugins and click the “Install” button for Stripe.

## Setup

To add the Stripe payment gateway, go to Commerce → Settings → Gateways, create a new gateway, and set the gateway type to “Stripe”.

## Payment security enforcement

This plugin does not allow submitting credit card details directly to Stripe gateway. Instead, you must tokenize the card before submitting the payment form. See [here](src/resources/js/paymentForm.js) for an example on how it's done when calling the default `getPaymentFormHtml()` method on the gateway.

## 3D secure payments

To allow 3D Secure payments, you must perform some additional steps.

### Configure Stripe

Set up a webhook endpoint in your Stripe dashboard API settings that emits at least the following events:

 * `source.cancelled`
 * `source.chargeable`
 * `source.failed`

The URL for this endpoint can be found in your Stripe gateway settings.

### Configure the gateway

When the endpoint has been set up, you can view the signing secret in its settings. Enter this value in your Stripe gateway settings in the appropriate field.

### Disabling CSRF for webhooks.

You must disable CSRF protection for the incoming requests, assuming it is enabled for the site (default for Craft since 3.0).

A clean example for how to go about this can be found [here](https://craftcms.stackexchange.com/a/20301/258).

### Forcing a 3D secure payment.

For some cards 3D secure payments are not supported, for some they are mandatory while for some cards they are optional. Setting this setting to true for a gateway will force the 3D secure payment flow for cards which optionally support it.

Cards that do not support 3d secure payment will be unaffected by this setting.

## Events

### The `buildGatewayRequest` event

Plugins get a chance to provide additional metadata to any request that is made to Stripe in the context of paying for an order. This includes capturing and refunding transactions.

Note, that any changes to the `Transaction` model will be ignored and it is not possible to set `transactionId`, `clientIp` and `transactionReference` metadata keys.

```php
use craft\commerce\models\Transaction;
use craft\commerce\stripe\events\BuildGatewayRequestEvent;
use craft\commerce\stripe\gateways\Gateway as StripeGateway;
use yii\base\Event;

// ...

Event::on(StripeGateway::class, StripeGateway::EVENT_BUILD_GATEWAY_REQUEST, function(BuildGatewayRequestEvent $e) {
    if ($e->transaction->type === 'refund') {
        $e->metadata['someKey'] = 'some value';
    }
});
```

### The `afterSaveInvoice` event

Plugins can get notified whenever a new invoice has been generated by Stripe and saved to the databse by this plugin.

```php
use craft\commerce\models\Invoice;
use craft\commerce\stripe\events\SaveInvoiceEvent;
use craft\commerce\stripe\services\Invoices;
use yii\base\Event;

// ...

Event::on(Invoices::class, Invoices::EVENT_SAVE_INVOICE, function(SaveInvoiceEvent $e) {
    $stripeInvoiceId = $e->invoice->invoiceId;
    // Do something with the data...
});
```
